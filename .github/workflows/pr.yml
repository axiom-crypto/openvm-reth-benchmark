name: "PR"

on:
  push:
    branches:
      - "main"
  # Disable for now
  pull_request:

concurrency:
  group: "${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
  cancel-in-progress: true

jobs:
  lock-files:
    name: "Check lock files"
    runs-on: ["runs-on", "runner=8cpu-linux-x64", "run-id=${{ github.run_id }}"]
    env:
      CARGO_NET_GIT_FETCH_WITH_CLI: "true"
    steps:
      - name: "Checkout sources"
        uses: "actions/checkout@v4"

      # TEMPORARY
      - name: Give GitHub Actions access to openvm-org
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.GH_ACTIONS_DEPLOY_PRIVATE_KEY }}

      - name: "Update lock files"
        run: |
          cargo tree
          (cd ./bin/client-eth && cargo tree)

      - name: "Assert no changes"
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "Lock files not up to date"
            exit 1
          fi

  fmt:
    name: "Check code format"
    runs-on: ["runs-on", "runner=8cpu-linux-x64", "run-id=${{ github.run_id }}"]
    steps:
      - name: "Checkout sources"
        uses: "actions/checkout@v4"

      - name: "Setup nightly toolchain"
        uses: "actions-rs/toolchain@v1"
        with:
          toolchain: "nightly"
          profile: "minimal"
          components: "rustfmt"
          override: true

      # TEMPORARY
      - name: Give GitHub Actions access to openvm-org
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.GH_ACTIONS_DEPLOY_PRIVATE_KEY }}

      - name: "Check Rust format"
        run: |
          cargo fmt --all -- --check
